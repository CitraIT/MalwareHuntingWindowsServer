#-----------------------------------------------------------
# Citra IT - Excelencia em TI
# Script para escanear por malware com o MS Defender
# @Author: luciano@citrait.com.br
# @version: 0.1 of 2023-02-08
# @Usage: Powershell -EP ByPass -File ScanWithDefender.ps1
#-----------------------------------------------------------

# REFERENCES USED FOR THIS SCRIPT
# 1. https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/command-line-arguments-microsoft-defender-antivirus?view=o365-worldwide


# Get M$ Defender most recent executable from ProgramData
$MSDefenderBasePlatformPath = "C:\ProgramData\Microsoft\Windows Defender\Platform"
$MpCmdRun = Get-ChildItem -Path $MSDefenderBasePlatformPath -Recurse -Filter "MpCmdRun.exe" -Depth 1

# Performing a signature update before start a scan job
&$MpCmdRun.FullName -SignatureUpdate -MMPC
If($? -eq $True){
    Write-Host "Defender updated" -Fore Yellow
}Else{
    Write-Host "Error updating defender signatures"
}

# If Performing a Full Scan
# &$MpCmdRun.FullName -scan -scantype 2

# If Performing a Quick Scan
# &$MpCmdRun.FullName -scan -scantype 1

# If Performing a Custom Scan
$CustonScanFolder = 'C:\'
$output = &$MpCmdRun.FullName -scan -scantype 3 -File $CustonScanFolder -DisableRemediation -BootSectorScan 

# Any infection found? evaluate defender return default code
If($? -eq $False){
    Write-Host "============   ATTENTION   ===============" -Fore Red
    Write-Host "Malware Found. Check output of Defender`r`n$output"
}Else{
    Write-Host "No malware found." -Fore Green
}
